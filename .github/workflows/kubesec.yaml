name: KubeSec Scan

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  lint:
    name: Kubesec
    runs-on: ubuntu-latest
    continue-on-error: true  # DO NOT block merging
    permissions:
      actions: read
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Build local KubeSec image
        run: |
          git clone https://github.com/controlplaneio/kubesec.git
          cd kubesec
          docker build -t kubesec:local .
          docker run -d -p 8080:8080 kubesec:local http 8080

      - name: Get all changed yaml files
        id: changed-files
        # https://github.com/marketplace/actions/changed-files?version=v46.0.5
        uses: tj-actions/changed-files@6cb76d07bee4c9772c6882c06c37837bf82a04d3 # v46.0.5
        with:
          # To compare changes between the current commit and the last pushed remote commit set `since_last_remote_commit: true`. e.g
          # since_last_remote_commit: true
  
          # Avoid using single or double quotes for multiline patterns
          files: |
            **/**.yaml
            **/**.yml

      - name: List all changed yaml files
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          echo "### ðŸ›¡ï¸ KubeSec Results" > comment.md
          echo "" >> comment.md
          HAS_FAILURE=0

          for file in $ALL_CHANGED_FILES; do
            if ! grep -qE '^\s*apiVersion:' "$file" || ! grep -qE '^\s*kind:' "$file"; then
              echo "â„¹ï¸ Skipping \`$file\` (not a Kubernetes manifest)"
              continue
            fi

            RESPONSE=$(curl -sSX POST --data-binary @"$file" http://localhost:8080/scan)
            MESSAGE=$(echo "$RESPONSE" | jq -r '.[0].message')
            SCORE=$(echo "$RESPONSE" | jq -r '.[0].score')

            if [[ "$SCORE" -ge 0 ]]; then
              echo "âœ… \`$file\` Passed - $MESSAGE" >> comment.md
            else
              echo "âŒ \`$file\` Failed - $MESSAGE" >> comment.md
              HAS_FAILURE=1
            fi

            echo "" >> comment.md
            echo "<details>" >> comment.md
            echo "<summary>ðŸ“„ See full scan result</summary>" >> comment.md
            echo "<pre>" >> comment.md
            echo "$RESPONSE" | jq '.' >> comment.md
            echo "</pre>" >> comment.md
            echo "</details>" >> comment.md
            echo "" >> comment.md
          done

          if [[ "$HAS_FAILURE" -eq 1 ]]; then
            exit 1
          fi

      - name: Comment results
        uses: mshick/add-pr-comment@v2
        if: always()
        with:
          message-path: comment.md

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up KubeSec container..."
          CONTAINER_ID=$(docker ps -q --filter ancestor=kubesec:local)
          if [ -n "$CONTAINER_ID" ]; then
            docker stop "$CONTAINER_ID"
            docker rm "$CONTAINER_ID"
          else
            echo "No KubeSec container found."
          fi

          echo "Removing temporary comment file..."
          rm -f comment.md

          echo "Removing cloned KubeSec repository..."
          rm -rf kubesec
          echo "Cleanup complete."
