name: KubeSec Scan

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  workflow_dispatch:

jobs:
  lint:
    name: Kubesec
    runs-on: ubuntu-latest
    continue-on-error: true  # âœ… DO NOT block merging
    permissions:
      actions: read
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run kubesec scanner and format comment
        run: |
          echo "### ðŸ›¡ï¸ KubeSec Results for \`file.yaml\`" > comment.md

          RESPONSE=$(curl -sSX POST --data-binary @file.yaml https://v2.kubesec.io/scan)

          VALID=$(echo "$RESPONSE" | jq -r '.[0].valid')
          MESSAGE=$(echo "$RESPONSE" | jq -r '.[0].message')
          SCORE=$(echo "$RESPONSE" | jq -r '.[0].score')

          if [[ "$VALID" == "true" ]]; then
            echo "âœ… **KubeSec check passed** â€“ $MESSAGE (score: $SCORE)" >> comment.md
          else
            echo "âŒ **KubeSec check failed** â€“ $MESSAGE (score: $SCORE)" >> comment.md
          fi

          echo "" >> comment.md
          echo "\`\`\`json" >> comment.md
          echo "$RESPONSE" | jq '.' >> comment.md
          echo "\`\`\`" >> comment.md

          # Exit with 1 if check failed
          if [[ "$VALID" != "true" ]]; then
            exit 1
          fi

      - name: Comment results
        uses: mshick/add-pr-comment@v2
        if: always()
        with:
          message-path: comment.md
